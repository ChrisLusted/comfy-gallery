<% content_for :head do %>
  <%= stylesheet_link_tag 'sofa_gallery/jquery.jcrop.css' %>
  <%= javascript_include_tag 'sofa_gallery/jquery.jcrop.js' %>
  <script type="text/javascript" charset="utf-8">
    $(function(){
      $('#cropbox').Jcrop({
        onChange: update_crop,
        onSelect: update_crop,
        aspectRatio: <%= @photo.gallery.force_ratio_full?? (@photo.gallery.full_width.to_f / @photo.gallery.full_height) : 'null' %>
      });
    });
    
    function update_crop(coords) {
      var ratio = <%= @photo.image_geometry(:original).width %> / <%= @photo.image_geometry(:admin_full).width %>;
      $('#crop_x').val(coords.x * ratio);
      $('#crop_y').val(coords.y * ratio);
      $('#crop_w').val(coords.w * ratio);
      $('#crop_h').val(coords.h * ratio);
    }
  </script>
<% end %>

<h1> Crop Photo </h1>

<%= image_tag @photo.image.url(:admin_full), :id => 'cropbox' %>

<%= sofa_gallery_form_for @photo, :as => :photo, :url => { :action => :update } do |form| %>
  <% [:crop_x, :crop_y, :crop_w, :crop_h].each do |attr| %>
    <%= form.hidden_field attr, :id => attr %>
  <% end %>
  <%= form.submit 'Crop' %>
<% end %>